import json
import pandas as pd
from mapping import mapping


def get_df():
    '''
        Store all the vulnerable code and all the patched code in a dataframe column
        Label the row as vulnerable or benign
        Vulnerable = 1
        Benign = 0
    '''
    code_lst = []
    label_lst = []
    with open('manual_investigation_30_advisory.txt','r') as f:
        temp_str = ''
        collect_vulnerable = False
        collect_benign = False
        for i in f:
            if 'vulnerable_code_highlighted' in i:
                #start collecting vulnerable code
                collect_vulnerable = True
            elif 'vulnerable_code_inside_full_function' in i:
                #make sure code exists
                temp_str = temp_str.strip(' ')
                if temp_str:  
                    #remove " or , at the end
                    temp_str = temp_str.strip('\n').strip(',').strip('"')
                    #add full vulnerable code to list
                    code_lst.append(temp_str)
                    label_lst.append(1) #label as benign
                temp_str = '' #reset
                collect_vulnerable = False
            elif 'revised_patch_highlighted' in i:
                #start collecting patch code
                collect_benign = True
            elif '-----------------------' in i:
                #make sure code exists
                temp_str = temp_str.strip(' ')
                if temp_str:  
                    #remove " or , at the end
                    temp_str = temp_str.strip('\n').strip(',').strip('"')
                    #add full patch code to list
                    code_lst.append(temp_str)
                    label_lst.append(0) #label as benign
                temp_str = '' #reset
                collect_benign = False
            elif collect_vulnerable or collect_benign:
                #add the line of code to the temporary string
                temp_str+=i.replace('"','\"')
            
    #get mapping of code
    mapped_code_lst = map_all_code(code_lst)

    data = {'Code':code_lst,'MappedCode':mapped_code_lst,'Label':label_lst}
    df = pd.DataFrame(data)

    return df

def map_all_code(code):
    '''
        map each snippet of code and return list of mapped code
    '''
    mcode_lst = []
    for i in code:
        map_code, _ = mapping(i)
        mcode_lst.append(map_code)

    return mcode_lst


if __name__ == '__main__':
    df = get_df()
    print(df.head(10))

    #save to an excel sheet to view easily
    df.to_excel('collected_data.xlsx',header=True)
    

